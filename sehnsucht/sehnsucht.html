<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA DE SUPERVIVENCIA AR - DYST</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <style>
        :root {
          --bg: #0b0a07;
          --fg: #d6a15c;
          --fg-dim: #8a6a3e;
          --line: #3b2a14;
          --alert: #c45a2a;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { background: #000; color: var(--fg); font-family: "Lucida Console", monospace; overflow: hidden; width: 100vw; height: 100vh; }

        #video-preview { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        #camera-shroud { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; opacity: 0.4; z-index: 2; pointer-events: none; }

        #glitch-overlay {
            position: fixed; inset: 0;
            z-index: 50;
            display: none; pointer-events: none;
            background-color: var(--bg);
            background-size: cover;
            background-position: center;
            mix-blend-mode: hard-light;
            filter: contrast(1.5) brightness(1.2);
            transition: opacity 0.05s steps(2);
        }

        #terminal-overlay {
            position: fixed; inset: 0;
            z-index: 60; pointer-events: none;
            padding: 20px;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        .hud-border { border: 1px solid var(--line); padding: 15px; background: rgba(11, 10, 7, 0.9); backdrop-filter: blur(5px); }
        .label { color: var(--fg-dim); font-size: 10px; letter-spacing: 0.12em; text-transform: uppercase; }
        h1 { font-size: 13px; letter-spacing: 0.15em; margin-bottom: 5px; }

        #target-ui {
            position: absolute; top: 50%; left: 50%;
            width: 240px; height: 240px;
            border: 1px solid rgba(214, 161, 92, 0.2);
            transform: translate(-50%, -50%);
            display: flex; align-items: flex-end; justify-content: center;
            padding-bottom: 15px;
        }

        #target-ui::before, #target-ui::after {
            content: ""; position: absolute; width: 30px; height: 30px; border: 2px solid var(--fg);
        }

        #target-ui::before { top: -2px; left: -2px; border-right: 0; border-bottom: 0; }
        #target-ui::after { bottom: -2px; right: -2px; border-left: 0; border-top: 0; }

        #target-hint { font-size: 10px; text-align: center; text-transform: uppercase; font-weight: bold; text-shadow: 0 0 10px #000; }

        #navigation-ui { display: none; text-align: center; margin-bottom: 30px; }
        .alert-msg { font-size: 16px; font-weight: bold; color: var(--alert); text-transform: uppercase; }
        .arrow { font-size: 80px; color: var(--alert); animation: pulse 0.8s ease-out infinite; }

        @keyframes pulse {
            0% { opacity: 0.2; transform: scale(0.9); }
            50% { opacity: 1; transform: scale(1); }
            100% { opacity: 0.2; transform: scale(0.9); }
        }
    </style>
</head>

<body>
<video id="video-preview" autoplay playsinline></video>
<div id="camera-shroud"></div>
<canvas id="qr-canvas" style="display:none;"></canvas>
<div id="glitch-overlay"></div>

<div id="terminal-overlay">
    <div class="hud-border">
        <div class="label">MODO: RECONSTRUCCIÓN VISUAL</div>
        <h1 id="system-status">SISTEMA INICIADO</h1>
    </div>

    <div id="target-ui">
        <div id="target-hint">BUSQUE PUNTO 0000 (PIZARRÓN)</div>
    </div>

    <div id="navigation-ui">
        <div class="alert-msg" id="nav-text">---</div>
        <div class="arrow" id="nav-arrow">➔</div>
    </div>

    <div class="hud-border" style="font-size:9px;color:var(--fg-dim);">
        PROTOCOLO_ALTA_LUMINOSIDAD // V.08
    </div>
</div>

<script>
const video = document.getElementById('video-preview');
const canvas = document.getElementById('qr-canvas');
const ctx = canvas.getContext('2d');
const glitch = document.getElementById('glitch-overlay');
const shroud = document.getElementById('camera-shroud');
const hint = document.getElementById('target-hint');
const navUI = document.getElementById('navigation-ui');
const navText = document.getElementById('nav-text');
const navArrow = document.getElementById('nav-arrow');
const status = document.getElementById('system-status');

let loop = null;
let scanLock = false;

const arrowMap = { right:"➔", left:"⬅", up:"⬆", down:"⬇" };

const STAGES = {
    Stage00:{msg:"SAL DEL SALÓN AHORA",hint:"CÓDIGO EN EL BALCÓN",images:["stage01-00.jpg","stage01-01.jpg"],arrow:"right"},
    Stage01:{msg:"GIRA A LA IZQUIERDA",hint:"CÓDIGO EN ESCALERAS",images:["stage01-02.jpg","stage01-03.jpg","stage01-04.jpg","stage01-05.jpg","stage01-06.jpg"],arrow:"left"},
    Stage02:{msg:"SIGUE BAJANDO",hint:"CÓDIGO EN RECICLAJE (PLANTA BAJA)",images:["stage02-00.jpg","stage02-01.jpg","stage02-02.jpg","stage02-03.jpg","stage02-04.jpg"],arrow:"down"},
    Stage03:{msg:"SAL AHORA",hint:"CÓDIGO EN POSTE DE LUZ",images:["stage03-00.jpg","stage03-01.jpg","stage03-02.jpg","stage03-03.jpg"],arrow:"up"},
    Stage04:{msg:"BUSCA EL REFUGIO (GIMNASIO)",hint:"CÓDIGO EN POSTE",images:["stage04-00.jpg","stage04-01.jpg","stage04-02.jpg","stage04-03.jpg"],arrow:"up"}, // Fixed: Added stage04-03
    Refuge:{isFinal:true}
};

const ALL_IMAGES = Object.values(STAGES)
    .flatMap(s => s.images || []);

function startLoop(images, chaos = 1) {
    if (loop) clearInterval(loop);
    glitch.style.display = "block";
    let i = 0;

    loop = setInterval(() => {
        glitch.style.backgroundImage = `url('sequence/${images[i]}')`;

        const r = Math.random();
        const opacity =
            r > 0.85 ? 0.15 :
            r > 0.6  ? 0.4  :
            r > 0.3  ? 0.7  : 0.9;

        glitch.style.opacity = opacity;
        shroud.style.opacity = 0.2 + Math.random() * 0.3;

        // Visual jitter/distortion
        const skew = chaos > 1 ? (Math.random() - 0.5) * 20 : 0;
        const scale = chaos > 1 ? 1 + Math.random() * 0.1 : 1;

        glitch.style.transform = `skew(${skew}deg) scale(${scale})`;
        glitch.style.filter =
            `contrast(${1.2 + Math.random()*0.8})
             brightness(${1 + Math.random()*0.3})
             ${r > 0.9 ? "invert(1)" : ""}`;

        i = (i + 1 + Math.floor(Math.random()*chaos)) % images.length;
    }, 380 + Math.random()*120);
}

async function processScan(cfg) {
    scanLock = true;
    status.innerText = "SEÑAL DE ALTA PRIORIDAD";

    if (cfg.isFinal) {
        status.innerText = "SISTEMA COMPROMETIDO";
        startLoop(shuffle([...ALL_IMAGES]), 5); // Increased chaos factor
        
        glitch.style.transition = "none"; // Immediate response for refuge
        
        // Rapid "death throes" glitching
        for (let i=0; i<35; i++) {
            glitch.style.opacity = Math.random();
            // Subtle UI flickering
            navUI.style.display = Math.random() > 0.5 ? "block" : "none";
            navText.innerText = Math.random() > 0.8 ? "FATAL_ERROR" : "REFUGIO_DETECTADO";
            
            await new Promise(r => setTimeout(r, 40 + Math.random() * 40));
        }
        
        window.location.href = "pulse.html";
        return;
    }

    startLoop(cfg.images);
    navText.innerText = cfg.msg;
    hint.innerText = cfg.hint;
    navArrow.innerText = arrowMap[cfg.arrow];
    navUI.style.display = "block";

    setTimeout(()=>scanLock=false, 3500);
}

function shuffle(a){
    for(let i=a.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
}

navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
.then(s=>{video.srcObject=s;requestAnimationFrame(scan)})
.catch(()=>status.innerText="ERROR ÓPTICO");

function scan(){
    if(video.readyState===4 && !scanLock){
        canvas.width=video.videoWidth;
        canvas.height=video.videoHeight;
        ctx.drawImage(video,0,0);
        const img=ctx.getImageData(0,0,canvas.width,canvas.height);
        const code=jsQR(img.data,img.width,img.height);
        if(code && STAGES[code.data]) processScan(STAGES[code.data]);
    }
    requestAnimationFrame(scan);
}

startLoop(["stage00-00.jpg"]);
</script>
</body>
</html>