<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>NODE://SINGLE_SHOWCASE_DAYLIGHT</title>
    <style>
        /* High Contrast Daylight Palette */
        :root { 
            --bg: #ffffff; 
            --grid: #dddddd; 
            --text: #000000; 
            --active-node: #0066ff; /* Deep blue projects better on white than pink */
            --dim-active: #e6f0ff;
        }

        body { 
            background: var(--bg); 
            color: var(--text); 
            font-family: 'Courier New', monospace; 
            margin: 0; 
            padding: env(safe-area-inset-top) 20px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            height: 100vh; 
            overflow: hidden; 
            -webkit-tap-highlight-color: transparent; 
            user-select: none; 
        }

        /* Subtle scanlines for daylight - reduced opacity to keep it clean */
        body::after { 
            content: ""; 
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(rgba(0,0,0,0) 50%, rgba(0,0,0,0.03) 50%); 
            background-size: 100% 4px; 
            pointer-events: none; 
            z-index: 1000; 
        }

        header { 
            letter-spacing: 3px; 
            font-size: 12px; 
            margin-bottom: 20px; 
            text-align: center; 
            z-index: 10; 
            font-weight: bold;
        }

        #score-container { 
            font-size: 12px; 
            margin-bottom: 40px; 
            color: #555; 
            z-index: 10; 
            font-weight: bold;
        }

        .matrix-container { 
            position: relative; 
            width: 200px; 
            height: 200px; 
            display: grid; 
            grid-template-columns: repeat(2, 80px); 
            grid-template-rows: repeat(2, 80px); 
            gap: 20px; 
            z-index: 10; 
        }

        .node { 
            width: 80px; 
            height: 80px; 
            background: #fafafa; 
            border: 2px solid #000; /* Thicker borders for projection */
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 11px; 
            font-weight: bold;
            transition: transform 0.2s cubic-bezier(0.17, 0.67, 0.83, 0.67); 
            cursor: pointer; 
            touch-action: none; 
        }

        .node.active { 
            border-color: var(--active-node); 
            background: var(--dim-active); 
            box-shadow: 0 0 20px rgba(0, 102, 255, 0.3); 
            color: var(--active-node); 
        }

        #init-btn { 
            margin-top: 60px; 
            background: #000; 
            border: 1px solid #000; 
            color: #fff; 
            padding: 12px 24px; 
            font-family: 'Courier New', monospace; 
            font-size: 12px; 
            letter-spacing: 2px; 
            z-index: 100; 
            cursor: pointer; 
            font-weight: bold;
        }

        #init-btn:hover {
            background: #333;
        }

        /* Glitch flash for white background needs to be a dark burst */
        .glitch-flash { animation: flash 0.15s ease-out; }
        @keyframes flash { 0% { background-color: #000; } 100% { background-color: #fff; } }
    </style>
</head>
<body>

<header>NODE://DAYLIGHT_UPLINK_v2</header>
<div id="score-container">STABILITY_INDEX: <span id="score-val">100%</span></div>
<div class="matrix-container" id="matrix">
    <div class="node" id="node-0" data-idx="0">[N_01]</div>
    <div class="node" id="node-1" data-idx="1">[N_02]</div>
    <div class="node" id="node-2" data-idx="2">[N_03]</div>
    <div class="node" id="node-3" data-idx="3">[N_04]</div>
</div>
<button id="init-btn">INIT_SYNC</button>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDXZbUQ81jxiGgH89gXdoH7pf2mSxp_rN0",
        authDomain: "technodrone-ce06d.firebaseapp.com",
        databaseURL: "https://technodrone-ce06d-default-rtdb.firebaseio.com",
        projectId: "technodrone-ce06d",
        appId: "1:869296657162:web:7e0bf1093fc59d4a99a0f3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const mirrorRef = ref(db, 'single_player_showcase');

    const nodes = document.querySelectorAll('.node');
    const initBtn = document.getElementById('init-btn');
    const scoreVal = document.getElementById('score-val');
    
    let sequence = [];
    let userIdx = 0;
    let isPlaying = false;
    let audioCtx;
    const freqs = [174.61, 185.00, 196.00, 207.65];

    function uplink(extra = {}) {
        update(mirrorRef, {
            id: localStorage.getItem('rhizome_id') || "DEMO_USER",
            sequence: sequence,
            current_step: userIdx,
            timestamp: Date.now(),
            ...extra
        });
    }

    function playNote(i) {
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'square';
        osc.frequency.setValueAtTime(freqs[i], audioCtx.currentTime);
        gain.gain.setValueAtTime(0.04, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.4);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.4);
    }

    function activateNode(i, isUser = false) {
        nodes[i].classList.add('active');
        playNote(i);
        setTimeout(() => nodes[i].classList.remove('active'), 250);
        if(isUser) {
            uplink({ last_tap: i });
            if(sequence.length >= 4) {
                const x = Math.floor(Math.random() * 60) - 30;
                const y = Math.floor(Math.random() * 60) - 30;
                nodes[i].style.transform = `translate(${x}px, ${y}px)`;
                document.body.classList.add('glitch-flash');
                setTimeout(() => document.body.classList.remove('glitch-flash'), 150);
            }
        }
    }

    async function playSequence() {
        isPlaying = true;
        userIdx = 0;
        scoreVal.textContent = `${Math.max(0, 100 - (sequence.length * 5))}%`;
        for (const i of sequence) {
            await new Promise(r => setTimeout(r, 700));
            activateNode(i);
        }
        isPlaying = false;
    }

    nodes.forEach((node, i) => {
        node.addEventListener('pointerdown', () => {
            if(isPlaying || sequence.length === 0) return;
            activateNode(i, true);
            if(i !== sequence[userIdx]) {
                scoreVal.textContent = "FAILURE";
                uplink({ status: "FAILED" });
                sequence = [];
                initBtn.style.display = "block";
                return;
            }
            userIdx++;
            if(userIdx === sequence.length) {
                setTimeout(() => {
                    sequence.push(Math.floor(Math.random() * 4));
                    playSequence();
                    uplink({ status: "PROGRESSING" });
                }, 1000);
            }
        });
    });

    initBtn.addEventListener('click', () => {
        nodes.forEach(n => n.style.transform = 'translate(0,0)');
        sequence = [Math.floor(Math.random() * 4)];
        initBtn.style.display = "none";
        uplink({ status: "STARTED" });
        playSequence();
    });
</script>
</body>
</html>