<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>NODE://STABILITY_FINAL_v2</title>
    <style>
        :root { 
            --bg: #000; 
            --text: #444; 
            --active-node: #fe7eaf; 
            --dim-active: rgba(254, 126, 175, 0.1);
            --btn-bg: #111;
            --btn-text: #fe7eaf;
            --glitch-color: #fff;
        }

        body.day-mode {
            --bg: #ffffff; 
            --text: #000; 
            --active-node: #0066ff; 
            --dim-active: #e6f0ff;
            --btn-bg: #000;
            --btn-text: #fff;
            --glitch-color: #000;
        }

        body { 
            background: var(--bg); 
            color: var(--text); 
            font-family: 'Courier New', monospace; 
            margin: 0; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            transition: background 1.5s ease; 
            overflow: hidden; 
            -webkit-tap-highlight-color: transparent;
        }

        header { letter-spacing: 3px; font-size: 11px; margin-bottom: 20px; text-transform: uppercase;}
        #env-info { color: var(--active-node); font-weight: bold; text-decoration: underline; cursor: pointer; }

        #score-container { 
            font-size: 12px; 
            margin-bottom: 40px; 
            color: var(--text); 
            font-weight: bold;
            letter-spacing: 1px;
        }

        .matrix-container { 
            display: grid; 
            grid-template-columns: repeat(2, 80px); 
            gap: 20px; 
            z-index: 10;
        }

        .node { 
            width: 80px; height: 80px; 
            border: 2px solid var(--text); 
            display: flex; align-items: center; justify-content: center; 
            font-size: 11px; cursor: pointer; touch-action: none;
            transition: transform 0.1s cubic-bezier(0.17, 0.67, 0.83, 0.67);
            background: transparent;
        }

        .node.active { 
            border-color: var(--active-node); 
            background: var(--dim-active); 
            color: var(--active-node); 
        }

        #init-btn { 
            margin-top: 60px; 
            background: var(--btn-bg); 
            border: 1px solid var(--active-node); 
            color: var(--btn-text); 
            padding: 12px 24px; 
            font-family: 'Courier New', monospace;
            cursor: pointer;
            z-index: 100;
            letter-spacing: 2px;
        }

        .glitch-flash { animation: flash 0.1s ease-out; }
        @keyframes flash { 0% { background-color: var(--glitch-color); opacity: 0.8; } 100% { background-color: var(--bg); opacity: 1; } }
    </style>
</head>
<body id="terminal-body">

<header>NODE://VARIABLE_SYNC | <span id="env-info">SYNCING...</span></header>
<div id="score-container">STABILITY_INDEX: <span id="score-val">100%</span></div>

<div class="matrix-container">
    <div class="node" id="node-0" data-idx="0">[N_01]</div>
    <div class="node" id="node-1" data-idx="1">[N_02]</div>
    <div class="node" id="node-2" data-idx="2">[N_03]</div>
    <div class="node" id="node-3" data-idx="3">[N_04]</div>
</div>

<button id="init-btn">INIT_SYNC</button>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDXZbUQ81jxiGgH89gXdoH7pf2mSxp_rN0",
        authDomain: "technodrone-ce06d.firebaseapp.com",
        databaseURL: "https://technodrone-ce06d-default-rtdb.firebaseio.com",
        projectId: "technodrone-ce06d",
        appId: "1:869296657162:web:7e0bf1093fc59d4a99a0f3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const mirrorRef = ref(db, 'single_player_showcase');

    let currentStability = 100;
    const info = document.getElementById('env-info');

    // 1. MANUAL OVERRIDE & TEMPORAL SYNC
    window.toggleEnv = function() {
        const isDay = document.body.classList.toggle('day-mode');
        info.innerText = isDay ? "ENV_DAYLIGHT" : "ENV_CORE";
    }
    info.onclick = window.toggleEnv;

    function checkTemporalState() {
        const hour = new Date().getHours();
        if (hour >= 7 && hour < 19) {
            document.body.classList.add('day-mode');
            info.innerText = "ENV_DAYLIGHT";
        } else {
            document.body.classList.remove('day-mode');
            info.innerText = "ENV_CORE";
        }
    }

    function getEnvelope() {
        const hour = new Date().getHours();
        let base = 0.4;
        if (hour >= 0 && hour < 6) base = 1.2;
        if (hour >= 12 && hour < 18) base = 0.15;
        const jitter = currentStability < 50 ? (Math.random() * 0.2) : 0;
        return base + jitter;
    }

    // 2. AUDIO ENGINE
    let audioCtx;
    const freqs = [174.61, 185.00, 196.00, 207.65];

    function playNote(i) {
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        const decay = getEnvelope();
        const pitchMultiplier = Math.pow(1.02, sequence.length);
        
        osc.type = 'square';
        osc.frequency.setValueAtTime(freqs[i] * pitchMultiplier, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.04, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + decay);
        
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + decay);
    }

    // 3. CORE LOGIC
    const nodes = document.querySelectorAll('.node');
    const initBtn = document.getElementById('init-btn');
    const scoreVal = document.getElementById('score-val');
    
    let sequence = [];
    let userIdx = 0;
    let isPlaying = false;
    let baseInterval = 700;

    function activateNode(i, isUser = false) {
        nodes[i].classList.add('active');
        playNote(i);
        const feedbackDuration = Math.max(100, 250 - (sequence.length * 10));
        setTimeout(() => nodes[i].classList.remove('active'), feedbackDuration);

        if(isUser) {
            const intensity = (100 - currentStability) / 2;
            const drift = intensity > 5 ? intensity : 0;
            if (drift > 0 || sequence.length >= 4) {
                const x = Math.floor(Math.random() * (drift + 20)) - (drift/2 + 10);
                const y = Math.floor(Math.random() * (drift + 20)) - (drift/2 + 10);
                nodes[i].style.transform = `translate(${x}px, ${y}px)`;
                if (Math.random() * 100 > currentStability) {
                    document.body.classList.add('glitch-flash');
                    setTimeout(() => document.body.classList.remove('glitch-flash'), 80);
                }
            }
            update(mirrorRef, {
                id: localStorage.getItem('rhizome_id') || "DEMO_USER",
                last_tap: i,
                current_stability: currentStability,
                timestamp: Date.now()
            });
        }
    }

    async function playSequence() {
        isPlaying = true;
        userIdx = 0;
        const acceleratedInterval = Math.max(150, baseInterval - (sequence.length * 30));
        currentStability = Math.max(0, 100 - (sequence.length * 5));
        scoreVal.textContent = `${currentStability}%`;
        for (const i of sequence) {
            await new Promise(r => setTimeout(r, acceleratedInterval));
            activateNode(i);
        }
        isPlaying = false;
    }

    nodes.forEach((node, i) => {
        node.addEventListener('pointerdown', (e) => {
            e.preventDefault();
            if(isPlaying || sequence.length === 0) return;
            activateNode(i, true);
            if(i !== sequence[userIdx]) {
                scoreVal.textContent = "FAILURE";
                currentStability = 100;
                sequence = [];
                initBtn.style.display = "block";
                return;
            }
            userIdx++;
            if(userIdx === sequence.length) {
                setTimeout(() => {
                    sequence.push(Math.floor(Math.random() * 4));
                    playSequence();
                }, 1000);
            }
        });
    });

    initBtn.onclick = () => {
        nodes.forEach(n => n.style.transform = 'translate(0,0)');
        sequence = [Math.floor(Math.random() * 4)];
        initBtn.style.display = "none";
        currentStability = 100;
        scoreVal.textContent = "100%";
        playSequence();
    };

    checkTemporalState();
    setInterval(checkTemporalState, 60000);
</script>
</body>
</html>