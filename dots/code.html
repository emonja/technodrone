<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>TERMINAL DE TELEGRAFÍA - MODO INCÓGNITO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<style>
:root {
  --bg: #0b0a07; --fg: #d6a15c; --fg-dim: #8a6a3e; --line: #3b2a14; --alert: #ff4e00; 
}
* { box-sizing: border-box; margin: 0; padding: 0; touch-action: manipulation; }
html, body {
  background: var(--bg); color: var(--fg);
  font-family: "Lucida Console", monospace; font-size: 13px; line-height: 1.35; overflow: hidden; 
}
body { padding: 15px; }
.system {
  max-width: 800px; margin: 0 auto; border: 1px solid var(--line); padding: 20px;
  position: relative; opacity: 0.3; pointer-events: none; transition: opacity 0.5s;
}
.system.active { opacity: 1; pointer-events: auto; }
#locked-overlay {
    display: none; color: var(--alert); text-align: center; padding: 12px;
    border: 1px dashed var(--alert); margin-bottom: 15px; font-weight: bold;
}
.system.locked #message-input { display: none; }
.system.locked #locked-overlay { display: block; }
#modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: var(--bg); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 20px;
}
.modal { border: 1px solid var(--fg); padding: 30px; text-align: center; background: #12100b; width: 100%; max-width: 400px; }
#tx-light { width: 14px; height: 14px; border-radius: 50%; background: #201a10; border: 1px solid var(--line); display: inline-block; vertical-align: middle; margin-right: 10px; }
#tx-light.active { background: var(--alert); box-shadow: 0 0 10px var(--alert); }
.label, .meta, .footer { color: var(--fg-dim); text-transform: uppercase; font-size: 10px; }
#log {
  height: 250px; overflow-y: auto; border: 1px solid var(--line); padding: 12px;
  margin-bottom: 12px; background: rgba(0,0,0,0.3); -webkit-overflow-scrolling: touch;
}
.morse-msg { margin-bottom: 6px; border-bottom: 1px solid #1a150e; padding-bottom: 4px; overflow-wrap: break-word; }
.nick { color: var(--fg); font-weight: bold; margin-right: 5px; }
input {
  width: 100%; background: transparent; border: 1px solid var(--line); color: var(--fg);
  font-family: inherit; font-size: 16px; padding: 12px; margin-bottom: 12px; border-radius: 0; -webkit-appearance: none;
}
.btn-sys {
    background: transparent; border: 1px solid var(--fg); color: var(--fg);
    padding: 12px 20px; font-family: inherit; cursor: pointer; text-transform: uppercase;
}
.btn-mute { border: 1px solid var(--fg-dim); color: var(--fg-dim); padding: 4px 8px; font-size: 9px; float: right; }
.btn-mute.on { border-color: var(--alert); color: var(--alert); }
.footer { margin-top: 15px; border-top: 1px solid var(--line); padding-top: 10px; display: flex; justify-content: space-between; align-items: center; }
</style>
</head>
<body>

<div id="modal-overlay">
    <div class="modal">
        <h2 style="margin-bottom: 15px; letter-spacing: 0.1em;">ACCESO TERMINAL</h2>
        <button class="btn-sys" id="init-btn">ESTABLECER VÍNCULO</button>
    </div>
</div>

<div class="system" id="terminal-ui">
  <button class="btn-mute" id="mute-btn">AUDIO: ON</button>
  <div class="label">UNIDAD: TERMINAL_MORSE_V3</div>
  <h1><div id="tx-light"></div>CANAL_01</h1>
  <p class="meta">ID: <span id="current-nick">---</span></p>
  <hr>
  <div id="log"></div>
  <div id="locked-overlay">CANAL CERRADO</div>
  <input type="text" id="message-input" placeholder="ESCRIBIR..." autocomplete="off">
  <div class="footer">
    <div class="label">MODO: INCÓGNITO</div>
    <button class="btn-sys" style="font-size: 10px; padding: 5px 10px;" id="btn-download">LOG_DUMP</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDXZbUQ81jxiGgH89gXdoH7pf2mSxp_rN0",
  authDomain: "technodrone-ce06d.firebaseapp.com",
  databaseURL: "https://technodrone-ce06d-default-rtdb.firebaseio.com",
  projectId: "technodrone-ce06d",
  appId: "1:869296657162:web:7e0bf1093fc59d4a99a0f3"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const chatRef = ref(db, "morse_chat");
const statusRef = ref(db, "system_status");

const myNick = "ANON_" + Math.random().toString(36).substr(2, 4).toUpperCase();
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let isMuted = false;

const MORSE_LIB = { 'A': '.-', 'B': '-...', 'C': '-.-.', 'D': '-..', 'E': '.', 'F': '..-.', 'G': '--.', 'H': '....', 'I': '..', 'J': '.---', 'K': '-.-', 'L': '.-..', 'M': '--', 'N': '-.', 'Ñ': '--.--', 'O': '---', 'P': '.--.', 'Q': '--.-', 'R': '.-.', 'S': '...', 'T': '-', 'U': '..-', 'V': '...-', 'W': '.--', 'X': '-..-', 'Y': '-.--', 'Z': '--..', '1': '.----', '2': '..---', '3': '...--', '4': '....-', '5': '.....', '6': '-....', '7': '--...', '8': '---..', '9': '----.', '0': '-----', ' ': '/' };

document.getElementById('init-btn').addEventListener('click', () => {
    audioCtx.resume();
    document.getElementById('modal-overlay').style.display = 'none';
    document.getElementById('terminal-ui').classList.add('active');
    document.getElementById('current-nick').innerText = myNick;
    playMorseSequence(".... --- .-.. .-");
});

document.getElementById('mute-btn').addEventListener('click', function() {
    isMuted = !isMuted;
    this.innerText = isMuted ? "AUDIO: OFF" : "AUDIO: ON";
    this.classList.toggle('on', isMuted);
});

onValue(statusRef, (snapshot) => {
    document.getElementById('terminal-ui').classList.toggle('locked', !(snapshot.val()?.active ?? true));
});

document.getElementById('message-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && e.target.value.trim() !== '') {
        const text = e.target.value.toUpperCase();
        const morse = text.split('').map(c => MORSE_LIB[c] || '').join(' ');
        push(chatRef, { sender: myNick, morse: morse, timestamp: serverTimestamp() });
        e.target.value = '';
    }
});

onChildAdded(chatRef, (snapshot) => {
    const data = snapshot.val();
    const div = document.createElement('div');
    div.className = 'morse-msg';
    div.innerHTML = `<span class="nick">&lt;${data.sender}&gt;</span> ${data.morse}`;
    document.getElementById('log').appendChild(div);
    document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight;
    playMorseSequence(data.morse);
});

async function playMorseSequence(morse) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    for (const char of morse) {
        if (char === '.' || char === '-') {
            const duration = char === '.' ? 80 : 250;
            document.getElementById('tx-light').classList.add('active');
            if (navigator.vibrate) navigator.vibrate(duration);
            if (!isMuted) {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.frequency.value = 750;
                osc.connect(gain); gain.connect(audioCtx.destination);
                gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                osc.start();
                setTimeout(() => osc.stop(), duration);
            }
            await new Promise(r => setTimeout(r, duration));
            document.getElementById('tx-light').classList.remove('active');
            await new Promise(r => setTimeout(r, 80));
        } else if (char === ' ') { await new Promise(r => setTimeout(r, 200)); }
          else if (char === '/') { await new Promise(r => setTimeout(r, 400)); }
    }
}

document.getElementById('btn-download').addEventListener('click', () => {
    const history = Array.from(document.querySelectorAll('.morse-msg')).map(el => el.innerText).join('\n');
    const blob = new Blob([history], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `LOG_${myNick}.txt`; a.click();
});
</script>
</body>
</html>